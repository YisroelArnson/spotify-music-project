<!doctype html>
<html lang="en">


<!-- 

    !Add in a max number of calls allowed. Display "Songs not found" if that max call is reached

    Add search specificity up to a single day.

    !Add ability to remove songs from the playlist before creating it

    Add functionality to add all songs from liked library to a playlist

    Figure out if I can get data about most listened to songs.

 -->

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://use.typekit.net/zxy0kqx.css">
    <title>Spotify Playlist Creator</title>
</head>

<body>

    <div class="jumbotron mb-0 pb-4" id="main-banner">
        <div class="container" id="banner-container">
            <h1 id="banner-title" class="muli-bold">REDISCOVER OLD FAVORITES!</h1>
            <h4 id="banner-sub-text" class="w-50 my-4 line-height-def">This is a tool that allows you to create Spotify playlists of songs you added
                from a specific time.
            </h4>
            <a class="btn btn-lg mt-3 mb-3 muli-bold" id="banner-button" href="#" role="button"><i style="font-size:20px" class="fa mr-2">&#xf04b;</i>
                Discover
            </a>
            <div class="row" id="filter-container">
                <div class="filter-buttons muli-bold lead filter-buttons-selected" onClick="changeSearchFilter('month', 0)">
                    Monthly
                </div>
                <div class="filter-buttons muli-bold lead" onClick="changeSearchFilter('range', 1)">
                    Range of Months
                </div>
                <div class="filter-buttons muli-bold lead" onClick="changeSearchFilter('all-time', 2)">
                    All Time
                </div>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="row my-4" id="end-date-inputs-row">
            <div class="col">
                <select class="form-control" onChange="getEndMonthVal()" id="end-month-list">
                    <option>Jan</option>
                    <option>Feb</option>
                    <option>Mar</option>
                    <option>Apr</option>
                    <option>May</option>
                    <option>Jun</option>
                    <option>Jul</option>
                    <option>Aug</option>
                    <option>Sep</option>
                    <option>Oct</option>
                    <option>Nov</option>
                    <option>Dec</option>
                </select>
            </div>
            <div class="col">
                <select class="form-control" onChange="getEndYearVal()" id="end-year-list">
                    <option>2020</option>
                    <option selected="selected">2019</option>
                    <option>2018</option>
                    <option>2017</option>
                    <option>2016</option>
                    <option>2015</option>
                    <option>2014</option>
                    <option>2013</option>
                    <option>2012</option>
                    <option>2011</option>
                    <option>2010</option>
                </select>
            </div>
        </div>
        <div class="row my-4">
            <div class="col">
                <select class="form-control" onChange="getMonthVal()" id="month-list">
                    <option>Jan</option>
                    <option>Feb</option>
                    <option>Mar</option>
                    <option>Apr</option>
                    <option>May</option>
                    <option>Jun</option>
                    <option>Jul</option>
                    <option>Aug</option>
                    <option>Sep</option>
                    <option>Oct</option>
                    <option>Nov</option>
                    <option>Dec</option>
                </select>
            </div>
            <div class="col">
                <select class="form-control" onChange="getYearVal()" id="year-list">
                    <option>2020</option>
                    <option>2019</option>
                    <option>2018</option>
                    <option>2017</option>
                    <option>2016</option>
                    <option>2015</option>
                    <option>2014</option>
                    <option>2013</option>
                    <option>2012</option>
                    <option>2011</option>
                    <option>2010</option>
                </select>
            </div>
        </div>

        <div class="row justify-content-center my-2">
            <button class="activation-buttons" id="search-songs-button" onClick="fetchSongs()">Search</button>
            <button class="activation-buttons" id="playlist-button" onClick="getUserInfo()">Create playlist</button>
        </div>


        <div id="song-list-container" class="mt-3">
            <div class="row align-items-center">
                <h3>Results</h3>
                <h5 id="song-count-element" class="text-muted mx-4">0</h5>
            </div>
            <!-- <div class="row">
                <div class="col-1">
                </div>
                <div class="col-5">
                    <p class="text-muted">Track Name</p>
                </div>
                <div class="col-3">
                    <p class="text-muted">Artist</p>
                </div>
                <div class="col-2">
                </div>
            </div>
        </div> -->

            <div id="results-container">
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
                <div class="row placeholder-listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <h6 class="align-self-center text-muted"></h6>
                        </div>
                        <div class="col-1">
                            <a class="mx-2" target=_blank>
                                <div class="placeholder-image mx-2 align-self-center"></div>
                            </a>
                        </div>
                    </div>

                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                        </a>
                    </div>
                    <div class="col-4">
                        <a class="mx-2" target=_blank>
                            <h7></h7>
                        </a>
                    </div>
                    <div class="col-2">
                        <button class="x-song-button float-right">
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <style>
            body {
                background-color: #f6f7fb;
            }

            .muli-bold {
                font-family: muli, sans-serif;
                font-weight: 700;
                font-style: normal;
            }

            .line-height-def {
                line-height: 1.5;
            }


            #main-banner {
                /* background: #7F7FD5; */
                background-color: #fffd80;
                /* fallback for old browsers */
                /* background: -webkit-linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5); */
                /* Chrome 10-25, Safari 5.1-6 */
                /* background: linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5); */
                /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */

                color: #2D3047;
            }

            #banner-title {
                font-size: 6vw;
            }

            #banner-button {
                background-color: #2c3049;
                color: #fff;
                border-radius: 50px;
                padding: 10px 40px;
                box-shadow: 0px 1px 10px rgba(0, 0, 0, 0.4);
                transition: all 0.4s;
            }

            #banner-button:hover {
                box-shadow: 0px 0px 1px rgba(0, 0, 0, 0.4);
            }

            #filter-container {
                margin-top: 30px;
            }

            .filter-buttons {
                cursor: pointer;
                margin: 0 20px;
            }

            .filter-buttons-selected {
                border-bottom: 2px solid #444;
                /* color: #666; */
            }

            .form-control {
                border: none;
                box-shadow: 0px 2px 5px rgba(51, 51, 79, 0.07);
            }

            #end-date-inputs-row {
                display: none;
            }

            a,
            a:hover,
            a:active {
                text-decoration: none;
                color: inherit;
                cursor: pointer;
            }

            .activation-buttons {
                background-color: #2c3049;
                padding: 10px 30px;
                border-radius: 8px;
                border: none;
                color: #fff;
                outline: none;
                margin: 0 1rem;
            }

            .activation-buttons:focus,
            .activation-buttons:active {
                border: none;
                outline: none;
            }

            .activation-buttons:hover {
                background-color: #212431;
            }

            .listing-body {
                transition: all 0.2s;
                background-color: #fff;
                border-radius: 8px;
                box-shadow: 0px 2px 5px rgba(51, 51, 79, 0.07);
            }

            .placeholder-listing-body {
                background-color: #e9ebf3;
                opacity: 0.7;
                border-radius: 8px;
                /* box-shadow: 0px 2px 5px rgba(51, 51, 79, 0.07); */
            }

            .placeholder-image {
                background-color: #cacedb;
                width: 45px;
                height: 45px;
            }

            .listing-images {
                border-radius: 3px;
            }

            .remove-song-button-container {
                height: 100%;
            }

            .x-song-button {
                padding: 12px;
                background: none;
                border: none;
                z-index: 1000;
            }

            .x-song-button:focus,
            .x-song-button:active {
                border: none;
                outline: none;
            }


            @media only screen and (max-width: 800px) {
                #banner-sub-text {
                    width: 100% !important;
                }
            }

            @media only screen and (max-width: 600px) {
                #banner-container {
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    text-align: center;
                }

                #banner-title {
                    font-size: 10vw;
                }

                #filter-container {
                    display: flex;
                    justify-content: center;
                }
            }

            @media only screen and (max-width: 500px) {
                #filter-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-direction: column;
                }

                .filter-buttons {
                    margin: 10px 0;
                }
            }
        </style>


        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
        </script>

        <script>
            var baseUrl = "https://spotifyplaylistcreator.herokuapp.com"
            // var baseUrl = "http://localhost:5000"
            var access_token = '';
            var month = document.getElementById("month-list").value;
            var year = document.getElementById("year-list").value;
            var endMonth = document.getElementById("end-month-list").value;
            var endYear = document.getElementById("end-year-list").value;
            var trackList = [];
            var removedTracks = [];
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const code = urlParams.get('code');
            var searchFilter = 'month';


            function changeSearchFilter(selector, selectedElemCount) {
                searchFilter = selector
                if (selector == 'range') {
                    document.getElementById('end-date-inputs-row').style.display = 'flex'
                } else {
                    document.getElementById('end-date-inputs-row').style.display = 'none'
                }

                var selecterElems = document.getElementsByClassName('filter-buttons')

                for (var i = 0; i < selecterElems.length; i++) {
                    selecterElems[i].classList.remove('filter-buttons-selected');
                }

                selecterElems[selectedElemCount].classList.add('filter-buttons-selected')
            }


            function getMonthVal() {
                month = document.getElementById("month-list").value;
            }


            function getYearVal() {
                year = document.getElementById("year-list").value;
            }

            function getEndMonthVal() {
                endMonth = document.getElementById("end-month-list").value;
            }


            function getEndYearVal() {
                endYear = document.getElementById("end-year-list").value;
            }


            function removeSong(songUri, songId) {
                var clickedListItem = document.getElementsByClassName(songId)[0]
                const index = trackList.indexOf(songUri);
                if (index > -1) {
                    trackList.splice(index, 1);
                    removedTracks.push({
                        songUri: songUri,
                        index: index
                    })
                    clickedListItem.style.opacity = 0.5;
                } else {
                    for (var i = 0; i < removedTracks.length; i++) {
                        if (removedTracks[i].songUri == songUri) {
                            trackList.splice(removedTracks[i].index, 0, songUri)
                            removedTracks.splice(i, 1)
                            clickedListItem.style.opacity = 1;
                        }
                    }
                }
            }


            function getToken() {
                fetch(baseUrl + '/tokencode', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json',
                        },
                        body: JSON.stringify({
                            code: code
                        })
                    }).then(response => {
                        console.log(response)
                        return response.json()
                    }).then(data => {
                        access_token = data.data.access_token
                        if (data.data.error) {
                            window.location = baseUrl + "/auth"
                        }
                    })
                    .catch(err => {
                        console.log(err)
                    })
            }


            function createSongListing(song, listingCounter) {
                document.getElementById("results-container").innerHTML +=
                    `
                                <div class="row listing-body justify-content-between align-items-center my-3 px-4  ${song.track.id}">
                                    <div class="row align-items-center">
                                        <div class="col-1">
                                            <h6 class="align-self-center text-muted">${listingCounter}</h6>
                                        </div>
                                        <div class="col-1">
                                            <a class="mx-2" href="${song.track.external_urls.spotify}"  target=_blank>
                                                <img class="align-self-center mx-2 listing-images" width="45" height="45" src="${song.track.album.images[2].url}" />
                                            </a>
                                        </div>
                                    </div>
                                     
                                    <div class="col-4">
                                        <a class="mx-2" href="${song.track.external_urls.spotify}"  target=_blank>
                                            <h6>${song.track.name}</h6>
                                        </a>
                                    </div> 
                                    <div class="col-4">
                                        <a class="mx-2" href="${song.track.external_urls.spotify}"  target=_blank>
                                            <h7>${song.track.artists[0].name}</h7>
                                        </a>
                                    </div> 
                                    <div class="col-2">
                                    </div> 
                                </div>
                            `
            }


            function clearSongListing() {
                document.getElementById("results-container").innerHTML = ''
            }


            function filterBySpecificMonth(song, listingCounter) {
                if (song.added_at.split('-')[1] == (getMonthFromString(month)) &&
                    song.added_at.split('-')[0] ==
                    year) {
                    trackList.push(song.track.uri);
                    createSongListing(song, listingCounter);
                    return true;
                }
                return false;
            }

            function filterByRange(song, listingCounter) {
                var songMonth = parseInt(song.added_at.split('-')[1]);
                var songYear = parseInt(song.added_at.split('-')[0]);
                var startMonth = getMonthFromString(month);
                var startYear = year
                var endMonth = getMonthFromString(endMonth);
                var endYear = endYear
                console.log(songMonth, songYear);


                // if(startMonth < songMonth < endMonth && < songYear) {
                // console.log(parseInt(song.added_at.split('-')[1]), getMonthFromString(month))
                // }

                if (song.added_at.split('-')[1] == ("0" + getMonthFromString(month)) &&
                    song.added_at.split('-')[0] ==
                    year) {
                    trackList.push(song.track.uri);
                    createSongListing(song, listingCounter);
                    return true;
                }
                return false;
            }


            function fetchSongs() {
                if (access_token) {
                    let offset = 0;
                    const limit = 50;
                    const numberOfTracks = 100;
                    let addedSongCount = 0;
                    var listingCounter = 1;
                    var callCount = 0;
                    var maxCallCount = 115;
                    var songCountElement = document.getElementById('song-count-element');
                    const controller = new AbortController()
                    const signal = controller.signal

                    trackList = [];
                    songCountElement.innerHTML = addedSongCount;
                    clearSongListing()

                    const fetchInterval = setInterval(function () {
                            fetch('https://api.spotify.com/v1/me/tracks?limit=' + limit + '&offset=' + offset, {
                                method: 'GET',
                                signal: signal,
                                headers: {
                                    'Authorization': 'Bearer ' + access_token
                                }
                            }).then(response => {
                                console.log(response)
                                return response.json()
                            }).then(data => {
                                console.log(data.items.length)
                                //If response is 0 stop sending request
                                if (data.items.length <= 0) {
                                    clearInterval(fetchInterval)
                                    controller.abort();
                                }

                                //Loop through returned response of songs and check if they match year and month
                                for (var i = 0; i < data.items.length; i++) {
                                    songCountElement.innerHTML = addedSongCount;
                                    let song = data.items[i]
                                    //Specific month (month, year)
                                    if (searchFilter == 'month') {
                                        if (filterBySpecificMonth(song, listingCounter)) {
                                            addedSongCount += 1;
                                            listingCounter += 1;
                                        }
                                        //range of time (Start month, start year, end month, end year)
                                    } else if (searchFilter == 'range') {
                                        console.log('This is a range search')
                                        filterByRange(song, listingCounter)
                                    } else if (addedSongCount != 0) {
                                        clearInterval(fetchInterval)
                                        controller.abort();
                                    }
                                }
                            }).catch(error => {
                                console.log(error)
                                clearInterval(fetchInterval)
                                controller.abort();
                            })
                            callCount += 1;
                            offset += limit;
                        },
                        200)
                }
            }


            function createPlaylist(userId) {
                fetch('https://api.spotify.com/v1/users/' + userId + '/playlists', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + access_token,
                        'content-type': 'application/json',

                    },
                    body: JSON.stringify({
                        "name": month + ' ' + year + ' top songs',
                        "description": 'The top songs in my song library from a specific month.',
                        "public": true
                    })
                }).then(response => {
                    console.log(response)
                    return response.json()
                }).then(data => {
                    addSongs(data.id)
                }).catch(error => console.log(error))
            }


            function addSongs(id) {
                var tempTrackList = []
                for (var i = 0; i <= trackList.length; i += 100) {
                    tempTrackList = trackList.slice(i, i + 100)

                    fetch('https://api.spotify.com/v1/playlists/' + id + '/tracks', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + access_token,
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify(tempTrackList)
                    }).then(response => {
                        console.log(response)
                        return response.json()
                    }).then(data => {
                        console.log(data)
                    }).catch(error => console.log(error))
                }
            }


            function getUserInfo() {
                fetch('https://api.spotify.com/v1/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    }
                }).then(response => {
                    console.log(response)
                    return response.json()
                }).then(data => {
                    console.log(data)
                    createPlaylist(data.id)
                })
            }


            function getMonthFromString(mon) {
                var date = new Date(Date.parse(mon + " 1, 2012")).getMonth() + 1
                if (("" + date).length == 1) {
                    return "0" + date;
                }
                return date;
            }


            getToken()
        </script>

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
        </script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
        </script>
</body>

</html>